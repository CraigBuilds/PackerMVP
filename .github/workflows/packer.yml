name: build-vm

on:
  workflow_dispatch:

jobs:
  build:
    name: Build VMs
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 xorriso

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: "1.11.0"

      - name: Fix key permissions
        run: chmod 600 Packer/keys/packer_ed25519

      - name: Initialize Packer template
        run: packer init Packer/templates/packer-vm.pkr.hcl

      - name: Validate Packer template (base)
        run: |
          packer validate \
            -var "iso_url=https://cloud-images.ubuntu.com/releases/jammy/release/ubuntu-22.04-server-cloudimg-amd64.img" \
            -var "output_directory=build-output-base" \
            -var "vm_name=craigs_vm_server" \
            -var "provision_script=Packer/provision/provision-base.sh" \
            -var "build_name=server-base" \
            Packer/templates/packer-vm.pkr.hcl

      - name: Build server base VM
        run: |
          packer build \
            -var "iso_url=https://cloud-images.ubuntu.com/releases/jammy/release/ubuntu-22.04-server-cloudimg-amd64.img" \
            -var "output_directory=build-output-base" \
            -var "vm_name=craigs_vm_server" \
            -var "provision_script=Packer/provision/provision-base.sh" \
            -var "build_name=server-base" \
            Packer/templates/packer-vm.pkr.hcl

      - name: Validate Packer template (desktop)
        run: |
          packer validate \
            -var "iso_url=build-output-base/craigs_vm_server" \
            -var "output_directory=build-output-desktop" \
            -var "vm_name=craigs_vm_desktop" \
            -var "provision_script=Packer/provision/provision-desktop.sh" \
            -var "build_name=desktop" \
            Packer/templates/packer-vm.pkr.hcl

      - name: Build desktop VM
        run: |
          packer build \
            -var "iso_url=build-output-base/craigs_vm_server" \
            -var "output_directory=build-output-desktop" \
            -var "vm_name=craigs_vm_desktop" \
            -var "provision_script=Packer/provision/provision-desktop.sh" \
            -var "build_name=desktop" \
            Packer/templates/packer-vm.pkr.hcl

      - name: Validate Packer template (optimize)
        run: |
          packer validate \
            -var "iso_url=build-output-desktop/craigs_vm_desktop" \
            -var "output_directory=build-output-optimize" \
            -var "vm_name=craigs_vm" \
            -var "provision_script=Packer/provision/provision-optimize.sh" \
            -var "build_name=optimize" \
            Packer/templates/packer-vm.pkr.hcl

      - name: Build optimized VM
        run: |
          packer build \
            -var "iso_url=build-output-desktop/craigs_vm_desktop" \
            -var "output_directory=build-output-optimize" \
            -var "vm_name=craigs_vm" \
            -var "provision_script=Packer/provision/provision-optimize.sh" \
            -var "build_name=optimize" \
            Packer/templates/packer-vm.pkr.hcl

      - name: Upload optimized VM artifact
        uses: actions/upload-artifact@v4
        with:
          name: optimized-vm
          path: build-output-optimize/*

  convert-qemu:
    name: Package QEMU VM
    needs: build
    uses: ./.github/workflows/convert-vm.yml
    with:
      input_artifact_name: "optimized-vm"
      input_vm_name: "craigs_vm"
      output_format: "qcow2"
      output_name: "craigs_vm_qemu"
      output_artifact_name: "vm-qemu"

  convert-virtualbox:
    name: Convert to VirtualBox
    needs: build
    uses: ./.github/workflows/convert-vm.yml
    with:
      input_artifact_name: "optimized-vm"
      input_vm_name: "craigs_vm"
      output_format: "vdi"
      output_name: "craigs_vm_virtualbox"
      output_artifact_name: "vm-virtualbox"

  convert-hyperv:
    name: Convert to Hyper-V
    needs: build
    uses: ./.github/workflows/convert-vm.yml
    with:
      input_artifact_name: "optimized-vm"
      input_vm_name: "craigs_vm"
      output_format: "vhdx"
      output_name: "craigs_vm_hyperv"
      output_artifact_name: "vm-hyperv"

  convert-proxmox:
    name: Package for Proxmox
    needs: build
    uses: ./.github/workflows/convert-vm.yml
    with:
      input_artifact_name: "optimized-vm"
      input_vm_name: "craigs_vm"
      output_format: "qcow2"
      output_name: "craigs_vm_proxmox"
      output_artifact_name: "vm-proxmox"

  release:
    name: Create Release
    needs: [convert-qemu, convert-virtualbox, convert-hyperv, convert-proxmox]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: vm-*
          merge-multiple: true

      - name: Display artifacts
        run: ls -lh artifacts/

      - name: Create release
        uses: ncipollo/release-action@v1
        with:
          tag: latest
          commit: ${{ github.sha }}
          name: latest
          makeLatest: true
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "artifacts/*"
          body: |
            # VM Images Release
            
            This release contains desktop VM images built with Packer in a three-stage process.
            
            ## Desktop Images
            Built from Ubuntu 22.04 cloud image with XFCE desktop environment in multiple formats:
            - **QEMU** (`craigs_vm_qemu.tar.gz`): QEMU/KVM qcow2 format
            - **VirtualBox** (`craigs_vm_virtualbox.tar.gz`): VirtualBox VDI format
            - **Hyper-V** (`craigs_vm_hyperv.tar.gz`): Microsoft Hyper-V VHDX format
            - **Proxmox** (`craigs_vm_proxmox.tar.gz`): Proxmox qcow2 format
            
            All VMs are based on Ubuntu 22.04 LTS cloud image with cloud-init configuration.
            
            ## Configuration
            
            - Username: `packer`
            - Local login password: `packer` (⚠️ **Change after first login!**)
            - SSH key authentication (password authentication disabled for SSH)
            - SSH public key available in repository
            - 2GB RAM, 2 CPU cores
            
            Extract the archives and import into your preferred virtualization platform.
