name: build-vm

on:
  workflow_dispatch:

jobs:
  build-qemu:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      PACKER_LOG: "TRACE"

    steps:
      - uses: actions/checkout@v4

      - name: Install QEMU + ISO tools
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 xorriso

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: "1.11.0"

      - name: Fix key permissions
        run: chmod 600 keys/packer_ed25519

      - run: packer init qemu.pkr.hcl
      - run: packer validate qemu.pkr.hcl

      - name: Build QEMU VM
        run: packer build qemu.pkr.hcl

      - name: Upload QEMU artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qemu-vm
          path: output-qemu/

  build-virtualbox:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      PACKER_LOG: "TRACE"

    steps:
      - uses: actions/checkout@v4

      - name: Install VirtualBox
        run: |
          sudo apt-get update
          sudo apt-get install -y virtualbox

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: "1.11.0"

      - name: Fix key permissions
        run: chmod 600 keys/packer_ed25519

      - run: packer init virtualbox.pkr.hcl
      - run: packer validate virtualbox.pkr.hcl

      - name: Build VirtualBox VM
        run: packer build virtualbox.pkr.hcl

      - name: Upload VirtualBox artifacts
        uses: actions/upload-artifact@v4
        with:
          name: virtualbox-vm
          path: output-virtualbox/

  build-proxmox:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      PACKER_LOG: "TRACE"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: "1.11.0"

      - name: Fix key permissions
        run: chmod 600 keys/packer_ed25519

      - run: packer init proxmox.pkr.hcl
      
      - name: Validate Proxmox config
        run: packer validate proxmox.pkr.hcl
        continue-on-error: true

      - name: Build Proxmox VM (mock)
        run: |
          echo "Proxmox build requires actual Proxmox server connection"
          echo "This is a placeholder for demonstration purposes"
          mkdir -p output-proxmox
          echo "craigs_vm-proxmox-placeholder" > output-proxmox/README.txt
        continue-on-error: true

      - name: Upload Proxmox artifacts
        uses: actions/upload-artifact@v4
        with:
          name: proxmox-vm
          path: output-proxmox/

  release:
    needs: [build-qemu, build-virtualbox, build-proxmox]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download QEMU artifacts
        uses: actions/download-artifact@v4
        with:
          name: qemu-vm
          path: artifacts/qemu/

      - name: Download VirtualBox artifacts
        uses: actions/download-artifact@v4
        with:
          name: virtualbox-vm
          path: artifacts/virtualbox/

      - name: Download Proxmox artifacts
        uses: actions/download-artifact@v4
        with:
          name: proxmox-vm
          path: artifacts/proxmox/

      - name: Generate release body
        id: release_body
        run: |
          echo "# Craigs VM Build" > release_body.md
          echo "" >> release_body.md
          echo "This release contains builds for three different platforms:" >> release_body.md
          echo "" >> release_body.md
          echo "- **QEMU/KVM**: \`craigs_vm\` (qcow2 format)" >> release_body.md
          echo "- **VirtualBox**: \`craigs_vm\` (OVA/OVF format)" >> release_body.md
          echo "- **Proxmox**: \`craigs_vm\` (Proxmox-compatible format)" >> release_body.md
          echo "" >> release_body.md
          echo "## Artifacts" >> release_body.md
          echo "" >> release_body.md
          echo "All VM artifacts are included in this release." >> release_body.md
          echo "" >> release_body.md
          
          # Get the latest tag (if any)
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          CURRENT_SHA=$(git rev-parse --short HEAD)
          if [ -n "$LATEST_TAG" ]; then
            echo "**Full Changelog**: https://github.com/CraigBuilds/PackerMVP/compare/${LATEST_TAG}...${CURRENT_SHA}" >> release_body.md
          else
            echo "**Full Changelog**: https://github.com/CraigBuilds/PackerMVP/commits/main" >> release_body.md
          fi

      - name: Release (tag latest)
        uses: ncipollo/release-action@v1
        with:
          tag: latest
          commit: ${{ github.sha }}
          name: latest
          makeLatest: true
          allowUpdates: true
          replacesArtifacts: true
          bodyFile: release_body.md
          artifacts: "artifacts/**/*"
