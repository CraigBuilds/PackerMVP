name: build-vm

on:
  workflow_dispatch:

jobs:
  build-base:
    name: Build Server Base VM
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 xorriso

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: "1.11.0"

      - name: Fix key permissions
        run: chmod 600 keys/packer_ed25519

      - name: Initialize and validate Packer (base)
        run: |
          packer init packer-base.pkr.hcl
          packer validate packer-base.pkr.hcl

      - name: Build server base VM
        run: packer build packer-base.pkr.hcl

      - name: Upload server base VM artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-base-vm
          path: build-output-base/craigs_vm_server

  build-desktop:
    name: Build Desktop VM
    needs: build-base
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 xorriso

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: "1.11.0"

      - name: Fix key permissions
        run: chmod 600 keys/packer_ed25519

      - name: Download server base VM
        uses: actions/download-artifact@v4
        with:
          name: server-base-vm
          path: build-output-base

      - name: Initialize and validate Packer (desktop)
        run: |
          packer init packer-desktop.pkr.hcl
          packer validate packer-desktop.pkr.hcl

      - name: Build desktop VM
        run: packer build packer-desktop.pkr.hcl

      - name: Upload desktop VM artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-vm
          path: build-output-desktop/craigs_vm_desktop

  convert-qemu:
    name: Package QEMU VMs
    needs: [build-base, build-desktop]
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Download server base VM
        uses: actions/download-artifact@v4
        with:
          name: server-base-vm
          path: server-base

      - name: Download desktop VM
        uses: actions/download-artifact@v4
        with:
          name: desktop-vm
          path: desktop

      - name: Package QEMU formats
        run: |
          mkdir -p dist
          cp server-base/craigs_vm_server dist/craigs_vm_server.qcow2
          cp desktop/craigs_vm_desktop dist/craigs_vm_desktop.qcow2
          tar -czf dist/craigs_vm_server_qemu.tar.gz -C dist craigs_vm_server.qcow2
          tar -czf dist/craigs_vm_desktop_qemu.tar.gz -C dist craigs_vm_desktop.qcow2

      - name: Upload QEMU VMs
        uses: actions/upload-artifact@v4
        with:
          name: vm-qemu
          path: dist/*.tar.gz

  convert-virtualbox:
    name: Convert to VirtualBox
    needs: [build-base, build-desktop]
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Download server base VM
        uses: actions/download-artifact@v4
        with:
          name: server-base-vm
          path: server-base

      - name: Download desktop VM
        uses: actions/download-artifact@v4
        with:
          name: desktop-vm
          path: desktop

      - name: Install qemu-utils
        run: sudo apt-get update && sudo apt-get install -y qemu-utils

      - name: Convert to VDI format
        run: |
          mkdir -p dist
          qemu-img convert -f qcow2 -O vdi server-base/craigs_vm_server dist/craigs_vm_server_virtualbox.vdi
          qemu-img convert -f qcow2 -O vdi desktop/craigs_vm_desktop dist/craigs_vm_desktop_virtualbox.vdi
          tar -czf dist/craigs_vm_server_virtualbox.tar.gz -C dist craigs_vm_server_virtualbox.vdi
          tar -czf dist/craigs_vm_desktop_virtualbox.tar.gz -C dist craigs_vm_desktop_virtualbox.vdi

      - name: Upload VirtualBox VMs
        uses: actions/upload-artifact@v4
        with:
          name: vm-virtualbox
          path: dist/*.tar.gz

  convert-hyperv:
    name: Convert to Hyper-V
    needs: [build-base, build-desktop]
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Download server base VM
        uses: actions/download-artifact@v4
        with:
          name: server-base-vm
          path: server-base

      - name: Download desktop VM
        uses: actions/download-artifact@v4
        with:
          name: desktop-vm
          path: desktop

      - name: Install qemu-utils
        run: sudo apt-get update && sudo apt-get install -y qemu-utils

      - name: Convert to VHDX format
        run: |
          mkdir -p dist
          qemu-img convert -f qcow2 -O vhdx server-base/craigs_vm_server dist/craigs_vm_server_hyperv.vhdx
          qemu-img convert -f qcow2 -O vhdx desktop/craigs_vm_desktop dist/craigs_vm_desktop_hyperv.vhdx
          tar -czf dist/craigs_vm_server_hyperv.tar.gz -C dist craigs_vm_server_hyperv.vhdx
          tar -czf dist/craigs_vm_desktop_hyperv.tar.gz -C dist craigs_vm_desktop_hyperv.vhdx

      - name: Upload Hyper-V VMs
        uses: actions/upload-artifact@v4
        with:
          name: vm-hyperv
          path: dist/*.tar.gz

  convert-proxmox:
    name: Package for Proxmox
    needs: [build-base, build-desktop]
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Download server base VM
        uses: actions/download-artifact@v4
        with:
          name: server-base-vm
          path: server-base

      - name: Download desktop VM
        uses: actions/download-artifact@v4
        with:
          name: desktop-vm
          path: desktop

      - name: Package for Proxmox (qcow2 format)
        run: |
          mkdir -p dist
          cp server-base/craigs_vm_server dist/craigs_vm_server_proxmox.qcow2
          cp desktop/craigs_vm_desktop dist/craigs_vm_desktop_proxmox.qcow2
          tar -czf dist/craigs_vm_server_proxmox.tar.gz -C dist craigs_vm_server_proxmox.qcow2
          tar -czf dist/craigs_vm_desktop_proxmox.tar.gz -C dist craigs_vm_desktop_proxmox.qcow2

      - name: Upload Proxmox VMs
        uses: actions/upload-artifact@v4
        with:
          name: vm-proxmox
          path: dist/*.tar.gz

  release:
    name: Create Release
    needs: [convert-qemu, convert-virtualbox, convert-hyperv, convert-proxmox]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: vm-*
          merge-multiple: true

      - name: Display artifacts
        run: ls -lh artifacts/

      - name: Create release
        uses: ncipollo/release-action@v1
        with:
          tag: latest
          commit: ${{ github.sha }}
          name: latest
          makeLatest: true
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "artifacts/*"
          body: |
            # VM Images Release
            
            This release contains virtual machine images built with Packer in a two-stage process:
            
            ## Server Base Images (Stage 1)
            Minimal server installation without desktop environment:
            - **QEMU Server** (`craigs_vm_server_qemu.tar.gz`): QEMU/KVM qcow2 format
            - **VirtualBox Server** (`craigs_vm_server_virtualbox.tar.gz`): VirtualBox VDI format
            - **Hyper-V Server** (`craigs_vm_server_hyperv.tar.gz`): Microsoft Hyper-V VHDX format
            - **Proxmox Server** (`craigs_vm_server_proxmox.tar.gz`): Proxmox qcow2 format
            
            ## Desktop Images (Stage 2)
            Built from server base with XFCE desktop environment:
            - **QEMU Desktop** (`craigs_vm_desktop_qemu.tar.gz`): QEMU/KVM qcow2 format
            - **VirtualBox Desktop** (`craigs_vm_desktop_virtualbox.tar.gz`): VirtualBox VDI format
            - **Hyper-V Desktop** (`craigs_vm_desktop_hyperv.tar.gz`): Microsoft Hyper-V VHDX format
            - **Proxmox Desktop** (`craigs_vm_desktop_proxmox.tar.gz`): Proxmox qcow2 format
            
            All VMs are based on Ubuntu 22.04 LTS cloud image with cloud-init configuration.
            
            ## Configuration
            
            - Username: `packer`
            - Local login password: `packer` (⚠️ **Change after first login!**)
            - SSH key authentication (password authentication disabled for SSH)
            - SSH public key available in repository
            - 2GB RAM, 2 CPU cores
            
            Extract the archives and import into your preferred virtualization platform.
