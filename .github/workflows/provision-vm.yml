name: provision-vm

on:
  workflow_call:
    inputs:
      iso_url:
        description: 'URL or path to the base image (cloud image or existing QCOW2)'
        required: true
        type: string
      output_directory:
        description: 'Directory where the build output will be stored'
        required: true
        type: string
      vm_name:
        description: 'Name of the VM output file'
        required: true
        type: string
      provision_script:
        description: 'Path to the provisioning script to run'
        required: true
        type: string
      build_name:
        description: 'Descriptive name for this build stage (e.g., server-base, desktop, optimize)'
        required: true
        type: string
      artifact_name:
        description: 'Name for the output artifact'
        required: true
        type: string

jobs:
  build-vm:
    name: Build VM - ${{ inputs.build_name }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 xorriso

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: "1.11.0"

      - name: Fix key permissions
        run: chmod 600 Packer/keys/packer_ed25519

      - name: Initialize Packer template
        run: packer init Packer/templates/packer-vm.pkr.hcl

      - name: Validate Packer template
        run: |
          packer validate \
            -var "iso_url=${{ inputs.iso_url }}" \
            -var "output_directory=${{ inputs.output_directory }}" \
            -var "vm_name=${{ inputs.vm_name }}" \
            -var "provision_script=${{ inputs.provision_script }}" \
            -var "build_name=${{ inputs.build_name }}" \
            Packer/templates/packer-vm.pkr.hcl

      - name: Build VM with Packer
        run: |
          packer build \
            -var "iso_url=${{ inputs.iso_url }}" \
            -var "output_directory=${{ inputs.output_directory }}" \
            -var "vm_name=${{ inputs.vm_name }}" \
            -var "provision_script=${{ inputs.provision_script }}" \
            -var "build_name=${{ inputs.build_name }}" \
            Packer/templates/packer-vm.pkr.hcl

      - name: Upload VM artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ inputs.output_directory }}/*
